<!DOCTYPE html>
<html>

<head lang="en">
	<title>Denon Controller Settings</title>
	<meta charset="utf-8" />
	<script src="https://sdpi-components.dev/releases/v3/sdpi-components.js"></script>
</head>

<body>
	<sdpi-item label="Receiver">
		<sdpi-select id="detectedReceiver" setting="detectedReceiver" datasource="getDetectedReceivers"
			loading="Searching for receivers...">
		</sdpi-select>
	</sdpi-item>
	<sdpi-item label="Host">
		<!-- TODO: Add hostname validation -->
		<sdpi-textfield id="host" setting="host" required placeholder="receiver.local"
			oninput="updateConnectButton()"></sdpi-textfield>
	</sdpi-item>
	<sdpi-item label="Auto Connect" style="display: none;">
		<sdpi-checkbox id="autoConnect" setting="autoConnect"></sdpi-checkbox>
	</sdpi-item>
	<sdpi-item>
		<sdpi-button id="connectBtn" onclick="connect(this)">Save & Connect</sdpi-button>
	</sdpi-item>
	<sdpi-item label="Status">
		<sdpi-textarea id="statusMsg" setting="statusMsg" disabled></sdpi-textarea>
	</sdpi-item>

	<script>
		const { streamDeckClient } = SDPIComponents;

		function updateElements() {
			const host = document.getElementById('host');
			const connectBtn = document.getElementById('connectBtn');
			const detectedReceiver = document.getElementById('detectedReceiver');

			host.disabled = !!detectedReceiver.value;
			connectBtn.disabled = !host.value;
		}

		async function connect(el) {
			el.disabled = true;
			await streamDeckClient.send('sendToPlugin', { event: 'connect' });
			el.disabled = false;
		}

		async function updateLayoutForAction() {
			let actionIdArray = (await streamDeckClient.getConnectionInfo()).actionInfo.action.split(".");
			let actionId = actionIdArray[actionIdArray.length - 1];

			switch (actionId) {
				case "power":
					document.title = "Denon Controller - Power";
					break;
				case "volume":
					document.title = "Denon Controller - Volume";
					break;
				case "source":
					document.title = "Denon Controller - Source";
					break;
			}
		}

		streamDeckClient.didReceiveSettings.subscribe(updateElements);

		// Ensure the connect button is updated after the page loads
		setTimeout(() => {
			updateConnectButton();
			updateLayoutForAction();
		}, 1);
	</script>
</body>

</html>