<!DOCTYPE html>
<html>

<head lang="en">
	<title>Denon Controller Settings</title>
	<meta charset="utf-8" />
	<script src="https://sdpi-components.dev/releases/v3/sdpi-components.js"></script>
</head>

<body>
	<sdpi-item label="Receiver">
		<sdpi-select id="receiverSelect" setting="host" label-setting="name" datasource="getDiscoveredReceivers"
			loading="Searching for receivers..." hot-reload="true" oninput="userChoseReceiver()">
		</sdpi-select>
	</sdpi-item>
	<!-- NOTE: May re-use these later for manual entry of receiver details -->
	<!--
	<sdpi-item label="Name">
		<sdpi-textfield id="name" setting="name" placeholder="Living Room"></sdpi-textfield>
	</sdpi-item>
	<sdpi-item label="Host">
		<sdpi-textfield id="host" setting="host" required placeholder="192.168.10.100"
			oninput="updateConnectButton()"></sdpi-textfield>
	</sdpi-item>
	<sdpi-item>
		<sdpi-button id="connectBtn" onclick="connect()">Connect</sdpi-button>
	</sdpi-item>
	-->
	<sdpi-item label="Status">
		<sdpi-textfield id="statusMsg" setting="statusMsg" disabled></sdpi-textfield>
	</sdpi-item>
	<hr id="moreSettingsDivider" style="display: none;" />
	<sdpi-item label="Volume level" id="volumeLevel" style="display: none;">
		<sdpi-textfield setting="volumeLevel"></sdpi-textfield>
	</sdpi-item>

	<div id="debugMessage" style="color: white; display: none;"></div>

	<script>
		const { streamDeckClient } = SDPIComponents;

		/**
		 * Use the selected detected receiver.
		 * @param {HTMLSelectElement} el - The select element.
		 */
		async function userChoseReceiver() {
			const receiverSelect = document.getElementById('receiverSelect');
			receiverSelect.disabled = true;
			await streamDeckClient.send('sendToPlugin', { event: 'userChoseReceiver' });
			receiverSelect.disabled = false;
		}

		async function updateLayoutForAction() {
			const connectionInfo = await streamDeckClient.getConnectionInfo();
			const controller = connectionInfo.actionInfo.payload.controller;
			const actionIdArray = connectionInfo.actionInfo.action.split(".");
			const actionId = actionIdArray[actionIdArray.length - 1];
			// document.getElementById('debugMessage').innerText = "DEBUG: " + JSON.stringify(controller);

			switch (actionId) {
				case "power":
					document.title = "Denon Controller - Power";
					break;
				case "volume":
					document.title = "Denon Controller - Volume";
					if (controller === "Keypad") {
						document.getElementById('moreSettingsDivider').style.removeProperty('display');
						document.getElementById('volumeLevel').style.removeProperty('display');
					}
					break;
				case "source":
					document.title = "Denon Controller - Source";
					break;
			}
		}


		// Ensure the connect button is updated after the page loads
		setTimeout(() => {
			updateLayoutForAction();
		}, 1);
	</script>
</body>

</html>